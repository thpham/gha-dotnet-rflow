name: CI

on:
  push:
    branches:
      - main
      - develop
      - "release/**"
    paths:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.sln"
      - "Directory.Build.props"
      - "Directory.Packages.props"
      - "installer/**"
      - "tests/Scripts/**"
  pull_request:
    branches:
      - main
      - develop
      - "release/**"
    types: [opened, synchronize, reopened, labeled]
    paths:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.sln"
      - "Directory.Build.props"
      - "Directory.Packages.props"
      - "installer/**"
      - "tests/Scripts/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: "9.0.x"
  SOLUTION_FILE: "MyApp.sln"
  BUILD_CONFIGURATION: "Release"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup .NET
        # v5
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore NuGet cache
        # v4 - Read-only cache restore to prevent cache poisoning attacks
        # NuGet packages are immutable, so no hash-based invalidation needed
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run Unit Tests
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --no-build `
            --verbosity normal `
            --filter "Category!=Integration" `
            --logger "trx;LogFileName=test-results.trx" `
            --collect:"XPlat Code Coverage" `
            --results-directory ./TestResults

      - name: Publish Application
        run: dotnet publish src/MyApp/MyApp.csproj -c ${{ env.BUILD_CONFIGURATION }} --no-build -o ./publish

      - name: Upload Test Results
        # v4
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        if: always()
        with:
          name: test-results
          path: ./TestResults
          retention-days: 7

      - name: Upload Published Application
        # v4
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: published-app
          path: ./publish
          retention-days: 1

      # - name: Upload Coverage to Codecov
      #   # v5 - Disabled by default. To enable:
      #   # 1. Add CODECOV_TOKEN secret to repository settings
      #   # 2. Change 'if: false' to 'if: success()'
      #   uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
      #   with:
      #     files: ./TestResults/**/coverage.cobertura.xml
      #     fail_ci_if_error: false
      #     token: ${{ secrets.CODECOV_TOKEN }}

      - name: Save NuGet cache
        # v4 - Only save cache on push events (not PRs) to prevent cache poisoning
        # NuGet packages are immutable, so no hash-based invalidation needed
        if: github.event_name == 'push'
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required to cancel workflow on lint failure

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          persist-credentials: false

      - name: Setup .NET
        # v5
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Check formatting
        id: format-check
        run: dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Cancel workflow on lint failure
        if: steps.format-check.outcome == 'failure'
        # v7
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            console.log('Lint failed - cancelling workflow to save CI minutes');
            await github.rest.actions.cancelWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

      - name: Fail job if lint failed
        if: steps.format-check.outcome == 'failure'
        run: |
          echo "::error::Format check failed. Run 'dotnet format' to fix formatting."
          exit 1

  pester-tests:
    name: Pester Integration Tests
    runs-on: windows-latest
    needs: build-and-test
    continue-on-error: true # Allow workflow to continue even if integration tests fail
    permissions:
      contents: read

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          persist-credentials: false
          sparse-checkout: tests/Scripts

      - name: Download Published Application
        # v4
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: published-app
          path: ./publish

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck
          Import-Module Pester

      - name: Run Pester Integration Tests
        shell: pwsh
        env:
          CI: "true"
          SKIP_AUTH_TESTS: "true"
          API_BASE_URL: "http://localhost:5000"
        run: |
          # Start the application in background using plain HTTP for CI simplicity
          # Avoids certificate trust issues and HTTPS redirect complications
          # NOTE: App must be started in same shell session to avoid process lifecycle issues
          # across GitHub Actions steps (child processes may be killed when step ends)
          $env:ASPNETCORE_URLS = "http://localhost:5000"
          $env:ASPNETCORE_ENVIRONMENT = "CI"
          $appProcess = Start-Process -FilePath "./publish/MyApp.exe" -NoNewWindow -PassThru

          $testExitCode = 1
          try {
            # Wait for application to be ready (max 30 seconds)
            $maxAttempts = 30
            $ready = $false

            for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
              Start-Sleep -Seconds 1
              try {
                $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -TimeoutSec 2 -ErrorAction SilentlyContinue
                if ($response.StatusCode -eq 200) {
                  $ready = $true
                  Write-Host "Application is ready after $attempt seconds"
                  break
                }
              }
              catch {
                Write-Host "Waiting for application... attempt $attempt/$maxAttempts"
              }
            }

            if (-not $ready) {
              throw "Application failed to start within $maxAttempts seconds"
            }

            # Run Pester tests
            $config = New-PesterConfiguration
            $config.Run.Path = './tests/Scripts'
            $config.Run.Exit = $false  # Handle exit ourselves to ensure cleanup
            # Only exclude WindowsAuth tests (require domain environment)
            $config.Filter.ExcludeTag = @('WindowsAuth')
            $config.TestResult.Enabled = $true
            $config.TestResult.OutputPath = './TestResults/pester-results.xml'
            $config.TestResult.OutputFormat = 'NUnitXml'
            $config.Output.Verbosity = 'Detailed'

            $result = Invoke-Pester -Configuration $config
            $testExitCode = if ($result.FailedCount -gt 0) { 1 } else { 0 }
          }
          finally {
            # Stop the application gracefully
            if ($appProcess -and -not $appProcess.HasExited) {
              $appProcess | Stop-Process -Force -ErrorAction SilentlyContinue
              Write-Host "Application stopped"
            }
          }

          exit $testExitCode

      - name: Upload Pester Results
        # v4
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        if: always()
        with:
          name: pester-results
          path: ./TestResults/pester-results.xml
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────────
  # Preview MSI Installer (Label-Triggered)
  # ─────────────────────────────────────────────────────────────────────────────
  # To build a preview MSI for your PR:
  # 1. Add the 'preview-msi' label to your PR
  # 2. CI will build MSI installers for x64 and arm64
  # 3. A comment with download instructions will be added to the PR
  # ─────────────────────────────────────────────────────────────────────────────

  build-installer-preview:
    name: Build MSI Preview (${{ matrix.architecture }})
    runs-on: windows-latest
    needs: build-and-test
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'preview-msi')
    permissions:
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, arm64]

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup .NET
        # v5
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Add WiX Extensions
        run: wix extension add -g WixToolset.UI.wixext WixToolset.Util.wixext WixToolset.Iis.wixext

      - name: Build Application
        env:
          ARCH: ${{ matrix.architecture }}
        run: |
          dotnet publish src/MyApp/MyApp.csproj `
            -c Release `
            -r win-$env:ARCH `
            --self-contained `
            -o ./publish/win-$env:ARCH

      - name: Extract Version
        id: version
        shell: pwsh
        run: |
          [xml]$props = Get-Content Directory.Build.props
          $version = $props.Project.PropertyGroup.Version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Build MSI
        working-directory: installer
        env:
          PRODUCT_VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.architecture }}
        run: |
          wix build Package.wxs IISConfiguration.wxs Directories.wxs Features.wxs `
            -ext WixToolset.UI.wixext `
            -ext WixToolset.Util.wixext `
            -ext WixToolset.Iis.wixext `
            -arch $env:ARCH `
            -d ProductVersion=$env:PRODUCT_VERSION `
            -d InstallerPlatform=$env:ARCH `
            -d PublishDir=..\publish\win-$env:ARCH `
            -o ..\artifacts\MyApp-$env:PRODUCT_VERSION-win-$env:ARCH.msi

      - name: Upload MSI Artifact
        # v4
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: msi-installer-preview-${{ matrix.architecture }}
          path: ./artifacts/*.msi
          retention-days: 7

  comment-msi-preview:
    name: Comment MSI Preview Info
    runs-on: ubuntu-latest
    needs: build-installer-preview
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'preview-msi')
    permissions:
      pull-requests: write

    steps:
      - name: Comment PR with preview info
        # v7
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        env:
          VERSION: ${{ needs.build-installer-preview.outputs.version }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        with:
          script: |
            const version = process.env.VERSION;
            const runId = process.env.RUN_ID;
            const repo = process.env.REPO;

            const body = `## Preview MSI Installers

            MSI installers have been built for this PR:

            | Architecture | Artifact |
            |--------------|----------|
            | **x64** | \`msi-installer-preview-x64\` |
            | **arm64** | \`msi-installer-preview-arm64\` |

            **Version:** \`${version}\`

            ### Download Instructions

            1. Go to the [workflow run](https://github.com/${repo}/actions/runs/${runId})
            2. Scroll to the **Artifacts** section at the bottom
            3. Download the desired MSI installer

            Or use the GitHub CLI:
            \`\`\`bash
            # Download x64 installer
            gh run download ${runId} -n msi-installer-preview-x64

            # Download arm64 installer
            gh run download ${runId} -n msi-installer-preview-arm64
            \`\`\`

            > **Note:** Artifacts are retained for 7 days. Once the label is added, every new commit will automatically build new installers.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
