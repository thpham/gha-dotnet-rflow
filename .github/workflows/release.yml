name: Release

on:
  push:
    branches:
      - main
      - 'release/**'
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}

    steps:
      - name: Run Release Please
        # v4
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Output Release Info
        if: ${{ steps.release.outputs.release_created }}
        env:
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          MAJOR: ${{ steps.release.outputs.major }}
          MINOR: ${{ steps.release.outputs.minor }}
          PATCH: ${{ steps.release.outputs.patch }}
        run: |
          echo "Release created: ${TAG_NAME}"
          echo "Version: ${MAJOR}.${MINOR}.${PATCH}"

  build-and-publish:
    name: Build, Test & Publish
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}
          persist-credentials: false

      - name: Setup .NET
        # v4
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-releaser
        run: dotnet tool install --global dotnet-releaser

      - name: Run dotnet-releaser
        run: |
          dotnet-releaser run `
            --github-token "${{ secrets.GITHUB_TOKEN }}" `
            dotnet-releaser.toml
        env:
          DOTNET_RELEASER_VERSION: ${{ needs.release-please.outputs.version }}

  build-msi:
    name: Build MSI Installer
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: windows-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, arm64]

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}
          persist-credentials: false

      - name: Setup .NET
        # v4
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Add WiX Extensions
        run: wix extension add -g WixToolset.UI.wixext WixToolset.Util.wixext WixToolset.Iis.wixext

      - name: Build Application
        run: |
          dotnet publish src/MyApp/MyApp.csproj `
            -c Release `
            -r win-${{ matrix.architecture }} `
            --self-contained `
            -p:PublishSingleFile=false `
            -o ./publish/win-${{ matrix.architecture }}

      - name: Build MSI
        working-directory: installer
        env:
          PRODUCT_VERSION: ${{ needs.release-please.outputs.version }}
          ARCH: ${{ matrix.architecture }}
        run: |
          wix build Package.wxs IISConfiguration.wxs Directories.wxs Features.wxs `
            -arch $env:ARCH `
            -ext WixToolset.UI.wixext `
            -ext WixToolset.Util.wixext `
            -ext WixToolset.Iis.wixext `
            -d ProductVersion=$env:PRODUCT_VERSION `
            -d InstallerPlatform=$env:ARCH `
            -d PublishDir=..\publish\win-$env:ARCH `
            -o ..\artifacts\MyApp-$env:PRODUCT_VERSION-win-$env:ARCH.msi

      - name: Upload MSI Artifact
        # v4
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: msi-${{ matrix.architecture }}
          path: ./artifacts/*.msi

  upload-release-assets:
    name: Upload Release Assets
    needs: [release-please, build-msi]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download x64 MSI
        # v4
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: msi-x64
          path: ./artifacts

      - name: Download arm64 MSI
        # v4
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: msi-arm64
          path: ./artifacts

      - name: Generate Checksums
        run: |
          cd artifacts
          sha256sum ./*.msi > checksums.txt
          cat checksums.txt

      - name: Upload MSI to Release
        # v2
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            ./artifacts/*.msi
            ./artifacts/checksums.txt

  announce:
    name: Announce Release
    needs: [release-please, build-and-publish, upload-release-assets]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Send Teams Notification
        if: ${{ vars.TEAMS_WEBHOOK_URL != '' }}
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
          REPO: ${{ github.repository }}
          WEBHOOK_URL: ${{ vars.TEAMS_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" -d "{
            \"@type\": \"MessageCard\",
            \"@context\": \"http://schema.org/extensions\",
            \"themeColor\": \"0076D7\",
            \"summary\": \"New Release: ${VERSION}\",
            \"sections\": [{
              \"activityTitle\": \"MyApp ${VERSION} Released\",
              \"facts\": [{
                \"name\": \"Version\",
                \"value\": \"${VERSION}\"
              }, {
                \"name\": \"Tag\",
                \"value\": \"${TAG_NAME}\"
              }],
              \"markdown\": true
            }],
            \"potentialAction\": [{
              \"@type\": \"OpenUri\",
              \"name\": \"View Release\",
              \"targets\": [{
                \"os\": \"default\",
                \"uri\": \"https://github.com/${REPO}/releases/tag/${TAG_NAME}\"
              }]
            }]
          }" "${WEBHOOK_URL}"
